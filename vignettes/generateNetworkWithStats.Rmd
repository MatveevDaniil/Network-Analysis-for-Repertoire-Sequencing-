---
title: "Rep-Seq Network Graph with Node and Cluster Statistics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Rep-Seq Network Graph with Node and Cluster Statistics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this vignette, we demonstrate the usage of the `generateNetworkWithStats` function.

## Simulate Data

We begin by creating some toy data.

```{r example_data}
library(RepSeqNetworkAnalysis)
set.seed(42)
sample_size <- 200
group_labels <- rep("Control", times = sample_size)
assign_treatment <- sample(c(TRUE, FALSE), size = sample_size, replace = TRUE)
base_seq_length <- 7
characters <- c("G", "A", "T", "C")
char_probs <- c(2/3, 2/9, 1/18, 1/18)
characters_sample <- sample(characters, 
                            size = base_seq_length * sample_size, 
                            replace = TRUE, prob = char_probs)
characters_sample <- matrix(characters_sample, ncol = sample_size)
clonotypes <- apply(characters_sample, MARGIN = 2, 
                    FUN = function(x) paste0(x, collapse = ""))
clonotypes_append <- rep("AATC", times = sample_size)
append_latent_prob <- runif(sample_size, min = 0, max = 1)
for (i in 1:sample_size) {
  treat <- assign_treatment[[i]]
  if (treat) group_labels[[i]] <- "Treatment"
  if ((treat & append_latent_prob[[i]] > 0.9) |
      (!treat & append_latent_prob[[i]] > 0.5)) {
    clonotypes_append[[i]] <- "AATCGGGG"
  } else if ((treat & append_latent_prob[[i]] > 0.8) |
             (!treat & append_latent_prob[[i]] > 0.3)) {
    clonotypes_append[[i]] <- "AATCGGT"
  } else if ((treat & append_latent_prob[[i]] > 0.7) |
             (!treat & append_latent_prob[[i]] > 0.2)) {
    clonotypes_append[[i]] <- "AATCGCT"
  } else if ((treat & append_latent_prob[[i]] > 0.5) |
             (!treat & append_latent_prob[[i]] > 0.1)) {
    clonotypes_append[[i]] <- "AATTGCT"
  } else if ((treat & append_latent_prob[[i]] > 0.25) |
             (!treat & append_latent_prob[[i]] > 0.05)) {
    clonotypes_append[[i]] <- "AATTG"
  }
  clonotypes[[i]] <- paste0(clonotypes[[i]], clonotypes_append[[i]], 
                            collapse = "")
}
counts <- rbinom(sample_size, size = 300, prob = 0.1)
fractions <- counts/sum(counts)
data <- data.frame("clonotype" = clonotypes,
                   "count" = counts,
                   "fraction" = fractions,
                   "treatment_group" = group_labels)
head(data)
```


## Basic Usage

We use the `generateNetworkWithStats()` function to construct the network for our toy data. 
```{r first_example}
network <- 
  generateNetworkWithStats(
    data, 
    clone_col = "clonotype", count_col = "count", frac_col = "fraction",
    group_col = "treatment_group",
    output_dir = NULL)
```
When calling the function, in addition to supplying the data frame for our rep-seq data, we must specify the names or numbers of the columns for the clonotype sequence, count and frequency.  An optional `group_col` argument allows us to supply an additional variable that is used to encode the node colors in the network graph plot generated by the function; we choose to color the nodes by treatment group (if no argument for `group_col` is supplied, nodes will be colored by their network degree).

## Output

All data and objects generated for the network are contained in a list returned by `generateNetworkWithStats()`. Here we have stored the output in the object `network`. We examine the names of its contents:

```{r}
names(network)
```

Below is a description of each list item.

* `settings`: Parameter values used when calling the `generateNetworkWithStats()` function.
* `node_data`: A data frame containing the node-level network characteristics, along with the counts and frequencies.
* `cluster_data`: A data frame containing the cluster-level network characteristics.
* `adjacency_matrix`: The adjacency matrix for the network.
* `network_graph`: An `igraph` network object containing the edge list for the network.
* `graph_plot`: A `ggplot2` object, created with `ggraph`, containing a visual plot of the network graph.

The object `node_data` contains data on the following variables for each node in the network. It also contains all of the variables in the dataframe `data` originally supplied to `generateNetworkWithStats()`:
```{r cell_info}
names(network$node_data)
```
Note that the names of the first few columns are determined by the column names of our input data.

The object `cluster_data` contains data on the following variables for each cluster in the network:
```{r cluster_info}
names(network$cluster_data)
```

We view the `graph_plot` object generated by the function:
```{r fig.width = 8, fig.height = 8, out.width = "100%"}
network$graph_plot
```

 
If desired, we can modify the plot to change aspects such its aesthetics and labels through standard methods of working with `ggplot2` objects. Here we replace the title and subtitle with custom text.
```{r fig.width = 8, fig.height = 8, out.width = "100%"}
network$graph_plot +
  ggplot2::labs(title = "Sample Network for Toy Data",
                subtitle = "Hamming distance on nucleotide sequence")
```


## Optional Arguments

#### `dist_type`
The default distance type used to compute network adjacency is the Hamming distance (our version accepts differing string lengths by appending non-matching placeholder characters to the shorter string); other options are `"levenshtein"` for the Levenshtein (edit) distance, and `"euclidean_on_atchley"` (only applicable to amino acid sequences), which embeds the amino acid sequences in Euclidean space based on the Atchley factor representation of the amino acids and a trained encoding model, then uses the Euclidean distance between the embedded values.  

#### `edge_dist`
The maximum `dist_type` distance at which two clonotype sequences (nodes) are considered adjacent in the network (share an edge). The default value is `1`.

#### `min_seq_length`
Clonotype sequences whose length is below this value will be excluded from the network. The default value is `3`.

#### `aggregate_counts`
If `TRUE`, rows containing identical clonotype sequences are merged and their counts/frequencies aggregated. `FALSE` by default.

#### `group_col`
If non-null and `aggregate_counts = TRUE`, this column (name or number) of `data` will be used to distinguish identical clonotype sequences, which will only be merged within identical values of `group_col`. Additionally, the network graph plot will color nodes by the value of this variable if supplied.

