---
title: "Network Visualization"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Network Visualization}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center", 
  out.width = "100%",
  fig.width = 9, fig.height = 7
)
```

The `buildRepSeqNetwork` function includes various arguments that facilitate customization of the network visualization. In this vignette, we provide an overview and demonstration of these arguments.


## Simulate Data for Demonstration

For demonstration purposes, we simulate some toy data using built-in package functions.

```{r }
library(NAIR)
dir_out <- tempdir()
toy_data <- simulateToyData()
head(toy_data)
```

### Node Colors

#### Color nodes according to meta data

The nodes in the graph can be colored according to a variable in the node-level metadata. This is accomplished using the `color_nodes_by` argument, which accepts a character string specifying the name of the column containing the variable. The user can specify any variable that will be present in the node-level meta data returned by `buildRepSeqNetwork`, including any node-level network properties to be computed.

For example, when calling `buildRepSeqNetwork`, we can color the nodes based on the `CloneCount` column of the original input data by setting `color_nodes_by = "CloneCount"` as seen below.

```{r}
buildRepSeqNetwork(toy_data, seq_col = "CloneSeq", node_stats = TRUE,
                   color_nodes_by = "CloneCount", output_dir = NULL)
```

If the `color_nodes_by` argument is left unspecified, `buildRepSeqNetwork` will attempt to use an available variable to color the nodes. If a variable for clone count is provided using the `count_col` argument, this will be used. Otherwise the `cluster_id` variable will be used if it exists, followed by `degree`, then by other network properties. If no suitable options are available, the nodes will be left uncolored.

If the user does not wish the nodes to be colored dynamically, this can be specified by setting `color_nodes_by = NULL`. 


#### Adjust node color palette

A preset color palette can be used to color the nodes by providing the appropriate character string to the `color_scheme` argument. The argument accepts the following values:

* `"default"` for default `ggplot2` colors
* One of the following color scales from the `viridisLite` package. These scales are designed to maintain their perceptual uniformity (consistently across the scale, values close together appear similar, while values far apart appear distinct) when printed in grey scale or when viewed by individuals with common forms of color-blindness or color vision deficiency. More information, including images of the color scales, can be referenced in the [Introduction to the viridis color maps](https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html) vignette hosted on CRAN's website.
    * `"magma"` (or `"A"`)
    * `"inferno"` (or `"B"`)
    * `"plasma"` (or `"C"`)
    * `"viridis"` (or `"D"`)
    * `"cividis"` (or `"E"`)
    * `"rocket"` (or `"F"`)
    * `"mako"` (or `"G"`)
    * `"turbo"` (or `"H"`)
    * Any of the above color scales with `"-1"` appended, which reverses the direction of the color scale (e.g., `color_scheme = "viridis-1"`)
* A discrete color palette from `grDevices::hcl.pals()` (these can only be used if the variable used to color the nodes is discrete)


Below we show an example of using the `plasma` color scheme from the `viridisLite` package, with the direction of the color scale reversed:

```{r}
# Using the "plasma" color scheme with reversed color gradient
buildRepSeqNetwork(toy_data, seq_col = "CloneSeq", node_stats = TRUE,
                   color_nodes_by = "transitivity", 
                   color_scheme = "plasma-1", output_dir = NULL)
```


### Node Size

#### Adjust uniform node size

By default, all nodes are drawn at a uniform size value of 0.5. This results in the nodes appearing very small when the plot is saved using the default pdf dimensions of 12 inches wide by 10 inches tall. This default behavior is intended to prevent nodes from overlapping and obscuring edges in larger networks. 

A different uniform node size can be specified by providing a numeric value to the `size_nodes_by` argument. Below, we set the node size to 1.5, which is three times as large as the default node size:

```{r}
buildRepSeqNetwork(toy_data, seq_col = "CloneSeq", node_stats = TRUE,
                   color_nodes_by = "transitivity", color_scheme = "plasma-1",
                   size_nodes_by = 1.5, output_dir = NULL)
```



#### Size nodes according to meta data

Rather than draw all nodes using a uniform node size, it is possible to for the nodes to be sized according to a variable within the node-level metadata. This is achieved by providing the column name of the variable to the `color_nodes_by` argument.

The minimum and maximum node sizes can be specified using the `node_size_limits` argument, which accepts a numeric vector of length two, where the first entry is the minimum node size and the second entry is the maximum node size.

```{r}
# Size nodes dynamically by network degree; use custom size range
buildRepSeqNetwork(toy_data, seq_col = "CloneSeq", node_stats = TRUE,
                   color_nodes_by = "transitivity", color_scheme = "plasma-1",
                   size_nodes_by = "degree", 
                   node_size_limits = c(0.5, 1.5), output_dir = NULL)
```

### Labeling Clusters

If [cluster analysis is performed](buildRepSeqNetwork.html#cluster-analysis) when calling `buildRepSeqNetwork`, the output will include data on the resulting clusters, with each cluster identified by a cluster ID.

In order to more easily reference these clusters within the visual plot of the network graph, it is possible to label the clusters in the plot with their cluster IDs. This must be done after calling `buildRepSeqNetwork`, and is accomplished by using the the `addClusterLabels` function to modify the plot contained in the output of `buildRepSeqNetwork`. Note that `buildRepSeqNetwork` returns a list, and one of the elements of this list is another list named `plots`, which contains all plots generated by `buildRepSeqNetwork`.

The `addClusterLabels` function has two primary arguments. The plot to be modified is provided to the `plot` argument. The entire output list returned by `buildRepSeqNetwork` is provided to the `net` argument.

By default, only the 20 largest clusters by node count are labeled in order to preserve legibility. This number can be changed by providing a different value to the `top_n_clusters` argument. Instead of prioritizing the clusters to label based on their node count, a different variable within the cluster-level metadata can be used, so long as the variable is numeric. This is achieved by providing the column name of the variable to the `criterion` argument. The variable should be present in the `cluster_data` data frame contained in the output list of `buildRepSeqNetwork`. Rather than prioritizing the clusters with the greatest values of this variable, those with the lowest values can instead be prioritized for labeling by setting `greatest_values = FALSE`.

The size of the cluster ID labels can be adjusted by providing a numeric value to the `size` argument (the default is 5), and their color can be adjusted by providing a valid character string to the `color` argument (the default is `"black"`).

The `addClusterLabels` function assumes that the node-level meta data includes a variable named `cluster_id` that records the cluster membership of each node. This is the case when `buildRepSeqNetwork` is called with cluster analysis enabled. If this variable has a name different from `cluster_id` (e.g., if columns are manually renamed), the correct variable name must be provided to the `cluster_id_col` argument.


```{r}
# Generate network, but don't print the graph plot yet
network <- buildRepSeqNetwork(
  toy_data, seq_col = "CloneSeq", 
  node_stats = TRUE, cluster_stats = TRUE,
  color_nodes_by = "transitivity", color_scheme = "plasma-1",
  size_nodes_by = "degree", node_size_limits = c(0.5, 1.5), 
  print_plots = FALSE, output_dir = NULL)

# Add labels to the two largest clusters and print the plot
addClusterLabels(plot = network$plots$transitivity,
                 net = network,
                 top_n_clusters = 2,
                 criterion = "node_count" # (the default)
                 )
```


### Generate Multiple Plots of a Network

The `buildRepSeqNetwork` can generate multiple plots of the same network graph, with each plot coloring the nodes according to a different variable. This is accomplished by providing a vector of column names to the `color_nodes_by` argument instead of a single column name.

A different [color palette](#adjust-node-color-palette) can be used for each plot. This is achieved by providing a character vector to the `color_scheme` argument. This vector must have the same length as the vector provided to the `color_nodes_by` argument. The color palette specified by each entry will be applied to the corresponding plot. If, instead, a single value is provided to the `color_scheme` argument, the specified color palette will be applied to all of the plots.

```{r}
buildRepSeqNetwork(toy_data, seq_col = "CloneSeq", node_stats = TRUE, 
                   color_nodes_by = c("transitivity", "CloneCount"),
                   color_scheme = c("plasma-1", "default"),
                   size_nodes_by = "CloneCount", node_size_limits = c(0.1, 2.5),
                   output_dir = NULL)
```


### Title and Subtitle

The `output_name` argument is used in the names of files saved by `buildRepSeqNetwork`. By default, it is also used as the title for each plot generated by `buildRepSeqNetwork`. The default value of `output_name` is `"MyRepSeqNetwork"`.

By default, the subtitle of each plot contains information about the settings used to construct the network, including the values of the `dist_type` and `dist_cutoff` arguments.

A custom plot title and subtitle can be specified using the `plot_title` and `plot_subtitle` arguments, respectively. Either element can be omitted from the plot by supplying a `NULL` value to the corresponding argument, as shown below.

```{r}
buildRepSeqNetwork(toy_data, seq_col = "CloneSeq", node_stats = TRUE,
                   color_nodes_by = "transitivity", color_scheme = "plasma-1",
                   size_nodes_by = "degree", node_size_limits = c(0.5, 2.5),
                   plot_title = NULL, plot_subtitle = NULL, output_dir = NULL)
```



### Legend

#### Excluding Part or All of the Legend

By default, if the nodes are colored or sized dynamically according to a variable, a legend will be included in the plot showing the color scale and/or size scale. 

The color scale can be manually excluded from the legend by setting `color_legend = FALSE`. Similarly, setting `size_legend = FALSE` will exclude the size scale from the legend.

An exception to the default behavior occurs when the variable used to color the nodes is discrete with more than 20 distinct values. In this case the color scale is automatically excluded from the legend in order to prevent it from taking up excessive space in the plot. The name of the variable used to color the nodes is then reported in the plot's subtitle for reference.


#### Legend Titles

By default, the title shown above the color scale in the legend is the name of the variable used to color the nodes. A custom title can be specified by providing a character string to the `color_title` argument. Similarly, the default title for the size scale is the name of variable used to size the nodes, and a custom title can be specified using the `size_title` argument. Each of the `color_title` and `size_title` arguments can also be set to `NULL` in order to omit the respective title.

If a vector is provided to the `color_nodes_by` argument in order to [generate multiple plots](#generate-multiple-plots-of-a-network), then the `color_title` will accept a character vector of matching length, where each entry is the title for the color legend in the corresponding plot.


### Edge width

By default, the edges in the plot are drawn with a width of 0.1.

A different width can be used for the edges by setting the `edge_width` argument to a different value.



### Further customization

The `ggraph` object for each plot generated by `buildRepSeqNetwork()` is returned for downstream use. It can be manipulated using functions from the `ggplot2` package much like any plot created with the `ggplot` function. This provides the user total control to modify plots to their liking. See [this vignette](downstream_analysis.html) for further details.


### Excluding Plots

Use `print_plots = FALSE` to prevent plots from being printed to the R plotting window. Use `plots = FALSE` to prevent plots from being generated at all.

